<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Network Info Logger</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
    }
    h1 {
      color: #333;
    }
    p span {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>Network Information</h1>
  <p>IP: <span id="ip">Loading...</span></p>
  <p>Connection Type: <span id="type">Loading...</span></p>
  <p>Download Speed (Mbps): <span id="speed">Loading...</span></p>
  <p>Device Type: <span id="device">Loading...</span></p>
  <p>OS: <span id="os">Loading...</span></p>
  <p>Browser: <span id="browser">Loading...</span></p>
  <p>Model: <span id="model">Loading...</span></p>
  <p id="status">Gathering data...</p>

  <!-- UAParser.js -->
  <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@1.0.2/src/ua-parser.min.js"></script>

  <!-- Firebase Setup -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4wGbg2TIu9ER6rIpwO5xPtkhLaKjkttQ", // ✅ Add your API key
      authDomain: "netspace-f34cf.firebaseapp.com",
      projectId: "netspace-f34cf",
      storageBucket: "netspace-f34cf.appspot.com",
      messagingSenderId: "878420258741",
      appId: "1:878420258741:web:0117164ddeda68e71933fc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function getIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip || "unknown";
      } catch {
        return "unknown";
      }
    }

    function getConnectionInfo() {
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {};
      return {
        type: conn.effectiveType || "unknown",
        speed: conn.downlink || "unknown"
      };
    }

    async function getDeviceInfo() {
      const parser = new UAParser();
      const result = parser.getResult();

      const fallback = {
        type: result.device.type || "desktop",
        model: result.device.model || "unknown",
        os: result.os.name + " " + result.os.version,
        osBase: result.os.name || "UnknownOS",
        browser: result.browser.name + " " + result.browser.version
      };

      // Modern high-entropy detection
      if (navigator.userAgentData?.getHighEntropyValues) {
        try {
          const ua = await navigator.userAgentData.getHighEntropyValues([
            "platform", "platformVersion", "architecture", "model"
          ]);
          return {
            type: fallback.type,
            model: ua.model || fallback.model,
            os: `${ua.platform} ${ua.platformVersion}`,
            osBase: ua.platform || fallback.osBase,
            browser: fallback.browser
          };
        } catch (err) {
          console.warn("UserAgentData not available:", err);
        }
      }

      return fallback;
    }

    // Optional GeoIP support (e.g., country/city)
    async function getGeoLocation() {
      try {
        const res = await fetch("https://ipapi.co/json");
        const data = await res.json();
        return {
          country: data.country_name,
          city: data.city,
          region: data.region
        };
      } catch {
        return {};
      }
    }

    async function logData() {
      try {
        const ip = await getIP();
        const conn = getConnectionInfo();
        const device = await getDeviceInfo();
        // const location = await getGeoLocation(); // Optional

        // Update UI
        document.getElementById("ip").innerText = ip;
        document.getElementById("type").innerText = conn.type;
        document.getElementById("speed").innerText = conn.speed;
        document.getElementById("device").innerText = device.type;
        document.getElementById("os").innerText = device.os;
        document.getElementById("browser").innerText = device.browser;
        document.getElementById("model").innerText = device.model;

        const docId = `${device.osBase}-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;

        await setDoc(doc(collection(db, "networkLogs"), docId), {
          ip,
          connectionType: conn.type,
          downloadSpeedMbps: conn.speed,
          time: new Date().toISOString(),
          deviceType: device.type,
          deviceModel: device.model,
          os: device.os,
          browser: device.browser,
          // location: location || null
        });

        document.getElementById("status").innerText = `✅ Logged as: ${docId}`;
        console.log("Log success:", docId);
      } catch (err) {
        console.error("Logging failed:", err);
        document.getElementById("status").innerText = "❌ Failed to log data.";
      }
    }

    logData();
  </script>
</body>

</html>
